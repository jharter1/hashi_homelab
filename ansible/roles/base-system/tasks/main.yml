---
- name: Configure DNS in resolv.conf
  copy:
    content: |
      nameserver 10.0.0.10
      nameserver 1.1.1.1
    dest: /etc/resolv.conf
    mode: '0644'

- name: Install base packages
  ansible.builtin.apt:
    name:
      - nfs-common
      - curl
      - wget
      - vim
      - htop
      - jq
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: Check if systemd-resolved is used
  ansible.builtin.stat:
    path: /etc/systemd/resolved.conf
  register: resolved_conf

- name: Configure DNS servers in resolved.conf
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?DNS='
    line: 'DNS=10.0.0.1 1.1.1.1 1.0.0.1'
    state: present
  notify: restart systemd-resolved
  when: resolved_conf.stat.exists

- name: Configure FallbackDNS servers
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?FallbackDNS='
    line: 'FallbackDNS=8.8.8.8 8.8.4.4'
    state: present
  notify: restart systemd-resolved
  when: resolved_conf.stat.exists

- name: Create NAS mount point
  ansible.builtin.file:
    path: "{{ nas_mount_point }}"
    state: directory
    mode: '0755'
  when: nas_mount_source is defined

- name: Mount NAS storage
  ansible.posix.mount:
    path: "{{ nas_mount_point }}"
    src: "{{ nas_mount_source }}"
    fstype: nfs
    opts: defaults,nofail
    state: mounted
  when: nas_mount_source is defined

- name: Create host volume directories
  ansible.builtin.file:
    path: "{{ nas_mount_point }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    # Observability
    - { name: 'grafana_data', owner: '472', group: '472', mode: '0755' }
    - { name: 'loki_data', owner: '10001', group: '10001', mode: '0755' }
    - { name: 'prometheus_data', owner: '65534', group: '65534', mode: '0777' }
    - { name: 'alertmanager_data', owner: '65534', group: '65534', mode: '0755' }
    - { name: 'uptime_kuma_data', owner: '1000', group: '1000', mode: '0755' }
    
    # Infrastructure
    - { name: 'minio_data', mode: '0755' }
    - { name: 'homepage_data', mode: '0755' }
    - { name: 'traefik_acme', mode: '0755' }
    
    # Databases
    - { name: 'postgres_data', mode: '0755' }
    - { name: 'mariadb_data', owner: '999', group: '999', mode: '0755' }
    
    # Media & Content
    - { name: 'calibre_data', mode: '0755' }
    - { name: 'calibre_config', mode: '0755' }
    - { name: 'audiobookshelf_config', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'audiobookshelf_metadata', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'audiobookshelf_audiobooks', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'audiobookshelf_podcasts', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'syncthing_config', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'syncthing_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'freshrss_data', owner: '1000', group: '1000', mode: '0755' }
    
    # Storage & File Management
    - { name: 'nextcloud_data', owner: '1000', group: '1000', mode: '0755' }
    
    # Security
    - { name: 'vaultwarden_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'authelia_data', owner: '1000', group: '1000', mode: '0755' }
    
    # Development & Tools
    - { name: 'gitea_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'codeserver_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'gollum_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'woodpecker_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'harbor_data', owner: '10000', group: '10000', mode: '0755' }
    - { name: 'harbor_registry', owner: '10000', group: '10000', mode: '0755' }
    - { name: 'harbor_redis', owner: '999', group: '999', mode: '0755' }
    
    # Knowledge Management (NEW)
    - { name: 'trilium_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'linkwarden_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'linkwarden_postgres_data', mode: '0755' }
    - { name: 'wallabag_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'wallabag_images', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'wallabag_postgres_data', mode: '0755' }
    - { name: 'paperless_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'paperless_media', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'paperless_consume', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'paperless_export', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'paperless_postgres_data', mode: '0755' }
    - { name: 'paperless_redis', owner: '999', group: '999', mode: '0755' }
    - { name: 'drawio_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'bookstack_config', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'bookstack_mariadb_data', owner: '999', group: '999', mode: '0755' }
    - { name: 'harbor_postgres_data', mode: '0755' }
    
    # Testing & Monitoring
    - { name: 'speedtest_data', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'immich_upload', owner: '1000', group: '1000', mode: '0755' }
    - { name: 'immich_postgres', owner: '1000', group: '1000', mode: '0755' }

  when: node_type == 'client' and nas_mount_source is defined

- name: Sync homepage configuration files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../configs/homepage/"
    dest: "{{ nas_mount_point }}/homepage_data/"
    owner: root
    group: root
    mode: '0644'
  when: node_type == 'client' and nas_mount_source is defined
