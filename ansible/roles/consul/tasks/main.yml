---
# Install and configure Consul
- name: Create Consul system user
  user:
    name: consul
    system: yes
    shell: /bin/false
    create_home: no

- name: Create Consul directories
  file:
    path: "{{ item }}"
    state: directory
    owner: consul
    group: consul
    mode: '0755'
  loop:
    - /etc/consul.d
    - /opt/consul

- name: Install Consul configuration
  template:
    src: consul.hcl.j2
    dest: /etc/consul.d/consul.hcl
    owner: consul
    group: consul
    mode: '0640'
  notify: restart consul

- name: Create Consul systemd service
  copy:
    dest: /etc/systemd/system/consul.service
    content: |
      [Unit]
      Description=HashiCorp Consul - A Service Mesh Solution
      Documentation=https://www.consul.io/
      Requires=network-online.target
      After=network-online.target
      ConditionFileNotEmpty=/etc/consul.d/consul.hcl

      [Service]
      Type=notify
      User=consul
      Group=consul
      ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
      ExecReload=/bin/kill --signal HUP $MAINPID
      KillMode=process
      KillSignal=SIGTERM
      Restart=on-failure
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  notify: restart consul

- name: Register Node Exporter service in Consul
  copy:
    dest: /etc/consul.d/node-exporter.hcl
    content: |
      service {
        name = "node-exporter"
        port = 9100
        tags = ["monitoring", "node-exporter"]
        check {
          http     = "http://localhost:9100/metrics"
          interval = "10s"
          timeout  = "1s"
        }
      }
    owner: consul
    group: consul
    mode: '0640'
  notify: restart consul

- name: Register Consul UI service in Consul catalog
  copy:
    dest: /etc/consul.d/consul-ui.hcl
    content: |
      service {
        name = "consul-ui"
        port = 8500
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.consul-ui.rule=Host(`consul.lab.hartr.net`)",
          "traefik.http.routers.consul-ui.entrypoints=websecure",
          "traefik.http.routers.consul-ui.tls=true",
          "traefik.http.routers.consul-ui.tls.certresolver=letsencrypt",
          "traefik.http.routers.consul-ui.middlewares=authelia@file",
        ]
        check {
          name     = "consul-api"
          http     = "http://localhost:8500/v1/status/leader"
          interval = "10s"
          timeout  = "2s"
        }
      }
    owner: consul
    group: consul
    mode: '0640'
  when: consul_server | default(false)
  notify: reload consul

- name: Register external services in Consul catalog
  copy:
    dest: /etc/consul.d/external-services.hcl
    content: |
      services = [
        {
          name    = "nas"
          id      = "nas-nfs"
          address = "10.0.0.220"
          port    = 2049
          tags    = ["nas", "nfs", "storage", "external"]
          checks = [
            {
              name     = "nas-rpcbind"
              notes    = "NFS portmapper - required for NFS mount negotiation"
              tcp      = "10.0.0.220:111"
              interval = "30s"
              timeout  = "5s"
            },
            {
              name     = "nas-nfsd"
              notes    = "NFS daemon port"
              tcp      = "10.0.0.220:2049"
              interval = "30s"
              timeout  = "5s"
            }
          ]
        },
        {
          name    = "proxmox"
          id      = "proxmox-api"
          address = "10.0.0.21"
          port    = 8006
          tags    = ["proxmox", "hypervisor", "infrastructure", "external"]
          check = {
            name            = "proxmox-https"
            http            = "https://10.0.0.21:8006"
            tls_skip_verify = true
            interval        = "30s"
            timeout         = "5s"
          }
        }
      ]
    owner: consul
    group: consul
    mode: '0640'
  when: consul_server | default(false)
  notify: reload consul

- name: Register NFS mount health check on Nomad clients
  copy:
    dest: /etc/consul.d/nas-mount.hcl
    content: |
      service {
        name = "nas-mount"
        tags = ["nas", "nfs", "storage", "mount-check"]
        check {
          name     = "nfs-mount-reachable"
          notes    = "Verifies /mnt/nas is mounted and accessible on this client"
          args     = ["/bin/sh", "-c", "mountpoint -q /mnt/nas && test -r /mnt/nas"]
          interval = "30s"
          timeout  = "10s"
        }
      }
    owner: consul
    group: consul
    mode: '0640'
  when: not (consul_server | default(false))
  notify: reload consul

- name: Enable and start Consul service
  systemd:
    name: consul
    enabled: yes
    state: started
    daemon_reload: yes
