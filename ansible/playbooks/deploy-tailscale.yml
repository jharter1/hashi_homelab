---
# Deploy Tailscale on Nomad clients for remote access
# 
# Usage:
#   # Deploy on all clients
#   ansible-playbook playbooks/deploy-tailscale.yml
#
#   # Deploy only on the Traefik node (recommended first step)
#   ansible-playbook playbooks/deploy-tailscale.yml --limit nomad-client-1
#
#   # Use auth key for unattended install (get from https://login.tailscale.com/admin/settings/keys)
#   ansible-playbook playbooks/deploy-tailscale.yml -e "tailscale_auth_key=tskey-auth-xxxxx"

- name: Install Tailscale on Nomad clients
  hosts: nomad_clients
  become: yes
  
  vars:
    # Primary node advertises subnet routes to entire homelab network
    tailscale_advertise_routes: "{{ '10.0.0.0/24' if inventory_hostname == 'nomad-client-1' else omit }}"
    
    # Don't accept Tailscale DNS (use local DNS instead)
    tailscale_accept_dns: false
    
    # Set hostname based on inventory name
    tailscale_hostname: "{{ inventory_hostname }}"
    
    # Optional: Set auth key via -e flag or uncomment below
    # Get from: https://login.tailscale.com/admin/settings/keys
    # tailscale_auth_key: "tskey-auth-xxxxx-yyyyy"

  roles:
    - tailscale

  post_tasks:
    - name: Display Tailscale status
      ansible.builtin.command: tailscale status
      register: ts_status
      failed_when: false
      changed_when: false

    - name: Show Tailscale IPs
      ansible.builtin.command: tailscale ip -4
      register: ts_ip
      failed_when: false
      changed_when: false

    - name: Summary
      ansible.builtin.debug:
        msg: |
          
          ✅ Tailscale installed on {{ inventory_hostname }}
          
          Tailscale IPv4: {{ ts_ip.stdout if ts_ip.rc == 0 else 'Not yet authenticated' }}
          
          {% if inventory_hostname == 'nomad-client-1' %}
          ⚠️  IMPORTANT: Approve subnet routes!
          
          This node is advertising routes to 10.0.0.0/24
          You must approve this in Tailscale admin:
          
          1. Go to: https://login.tailscale.com/admin/machines
          2. Find machine: {{ tailscale_hostname }}
          3. Click "Edit route settings" or the three dots menu
          4. Toggle 10.0.0.0/24 from "Advertised" to "Approved"
          
          {% endif %}
          Status: {{ ts_status.stdout_lines[0] if ts_status.rc == 0 else 'Run `tailscale status` to check' }}
