---
# Deploy Tailscale subnet routers on client-1 and client-2 for resilient remote access.
# Both nodes advertise 10.0.0.0/24 — Tailscale automatically fails over if one goes down.
#
# Usage:
#   ansible-playbook playbooks/deploy-tailscale.yml -e "tailscale_auth_key=tskey-auth-xxxxx"
#
# Get a reusable auth key from: https://login.tailscale.com/admin/settings/keys
# After running, approve subnet routes for BOTH machines at:
#   https://login.tailscale.com/admin/machines

- name: Install Tailscale subnet routers on client-1 and client-2
  hosts:
    - nomad-client-1
    - nomad-client-2
  become: yes

  vars:
    # Both nodes advertise the full homelab subnet for failover
    tailscale_advertise_routes: "10.0.0.0/24"

    # Use local Consul DNS, not Tailscale's
    tailscale_accept_dns: false

    tailscale_hostname: "{{ inventory_hostname }}"

    # Pass via: -e "tailscale_auth_key=tskey-auth-xxxxx"
    # Get from: https://login.tailscale.com/admin/settings/keys
    # Use a reusable (non-ephemeral) key so nodes survive reboots without re-auth

  roles:
    - tailscale

  post_tasks:
    - name: Get Tailscale status
      ansible.builtin.command: tailscale status
      register: ts_status
      failed_when: false
      changed_when: false

    - name: Get Tailscale IP
      ansible.builtin.command: tailscale ip -4
      register: ts_ip
      failed_when: false
      changed_when: false

    - name: Summary
      ansible.builtin.debug:
        msg: |
          Tailscale on {{ inventory_hostname }}
          IP: {{ ts_ip.stdout if ts_ip.rc == 0 else 'Not yet authenticated' }}
          Status: {{ ts_status.stdout_lines[0] if ts_status.stdout_lines else 'unknown' }}

          NEXT: Approve subnet routes at https://login.tailscale.com/admin/machines
            - Find {{ inventory_hostname }} → Edit route settings → enable 10.0.0.0/24
